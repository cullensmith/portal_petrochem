<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet Map with Print</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        
        #map {
            height: 500px;
            width: 100%;
            border: 2px solid #333;
        }
        
        .controls {
            margin: 20px 0;
            text-align: center;
        }
        
        .print-btn {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
        }
        
        .print-btn:hover {
            background-color: #45a049;
        }
        
        .print-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        

        
        /* Print preview modal */
        .print-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }
        
        .print-content {
            position: relative;
            margin: 2% auto;
            width: 80%;
            height: 90%;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
        }
        
        .print-map {
            width: 100%;
            height: 80%;
            border: 1px solid #ddd;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .print-actions {
            text-align: center;
            margin-top: 15px;
        }
        
        .screenshot-btn {
            background-color: #2196F3;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 5px;
        }
        
        .screenshot-btn:hover {
            background-color: #1976D2;
        }
        
        .screenshot-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Interactive Map with Print Functionality</h1>
    
    <div class="controls">
        <button class="print-btn" onclick="showPrintPreview()">ðŸ“‹ Create Map Screenshot</button>
    </div>
    
    <div id="map"></div>
    
    <!-- Print Preview Modal -->
    <div id="printModal" class="print-modal">
        <div class="print-content">
            <button class="close-btn" onclick="closePrintPreview()">&times;</button>
            <div class="print-header">
                <h2>Map Screenshot Preview</h2>
                <p>Date: <span id="printDate"></span></p>
            </div>
            <div id="printMap" class="print-map"></div>
            <div class="print-actions">
                <button class="screenshot-btn" onclick="captureMapScreenshot()">ðŸ“¸ Download Screenshot</button>
                <button class="print-btn" onclick="closePrintPreview()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <!-- html2canvas for screenshot functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        let map;
        let printMapInstance;
        
        // Initialize the main map
        function initMap() {
            map = L.map('map').setView([40.7128, -74.0060], 10); // New York City
            
            // Add basemap (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            // Add some sample markers
            L.marker([40.7128, -74.0060]).addTo(map)
                .bindPopup('New York City<br>The Big Apple');
                
            L.marker([40.7589, -73.9851]).addTo(map)
                .bindPopup('Times Square<br>The Crossroads of the World');
                
            L.marker([40.6892, -74.0445]).addTo(map)
                .bindPopup('Statue of Liberty<br>Symbol of Freedom');
        }
        
// Screenshot preview function
        function showPrintPreview() {
            const modal = document.getElementById('printModal');
            const printDate = document.getElementById('printDate');
            
            // Set current date
            printDate.textContent = new Date().toLocaleDateString();
            
            // Show modal
            modal.style.display = 'block';
            
            // Create print map instance
            setTimeout(() => {
                if (printMapInstance) {
                    printMapInstance.remove();
                }
                
                printMapInstance = L.map('printMap').setView(map.getCenter(), map.getZoom());
                
                // Add the same basemap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(printMapInstance);
                
                // Copy markers from original map
                map.eachLayer(function(layer) {
                    if (layer instanceof L.Marker) {
                        const newMarker = L.marker(layer.getLatLng()).addTo(printMapInstance);
                        if (layer.getPopup()) {
                            newMarker.bindPopup(layer.getPopup().getContent());
                        }
                    }
                });
                
                // Ensure the print map renders properly
                setTimeout(() => {
                    printMapInstance.invalidateSize();
                }, 100);
            }, 100);
        }
        
        // Close screenshot preview
        function closePrintPreview() {
            document.getElementById('printModal').style.display = 'none';
            if (printMapInstance) {
                printMapInstance.remove();
                printMapInstance = null;
            }
        }
        
        // Capture screenshot of the print preview
        function captureMapScreenshot() {
            const captureButton = document.querySelector('.screenshot-btn');
            const originalText = captureButton.textContent;
            const title = document.querySelector('.print-header h2');
            const printActions = document.querySelector('.print-actions');
            const closeButton = document.querySelector('.close-btn');
            const originalTitle = title.textContent;
            
            // Update title and hide buttons
            title.textContent = 'FracTracker Data Portal';
            printActions.style.display = 'none';
            closeButton.style.display = 'none';
            
            // Wait a moment for changes to render
            setTimeout(() => {
                const printContent = document.querySelector('.print-content');
                
                html2canvas(printContent, {
                    useCORS: true,
                    allowTaint: true,
                    scale: 2, // Higher quality
                    logging: false,
                    width: printContent.offsetWidth,
                    height: printContent.offsetHeight,
                    backgroundColor: '#ffffff'
                }).then(function(canvas) {
                    // Create download link
                    const link = document.createElement('a');
                    link.download = `fractracker-map-${new Date().toISOString().slice(0,10)}.png`;
                    link.href = canvas.toDataURL('image/png');
                    
                    // Trigger download
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Show success message
                    showMessage('Screenshot saved successfully!', 'success');
                    
                    // Close the modal after a brief delay
                    setTimeout(() => {
                        closePrintPreview();
                    }, 1000);
                    
                }).catch(function(error) {
                    console.error('Screenshot failed:', error);
                    
                    // Restore original state on error
                    title.textContent = originalTitle;
                    printActions.style.display = 'block';
                    closeButton.style.display = 'block';
                    captureButton.disabled = false;
                    captureButton.textContent = originalText;
                    
                    showMessage('Screenshot failed. Please try again.', 'error');
                });
            }, 300);
        }
        
        // Show temporary message
        function showMessage(text, type) {
            const message = document.createElement('div');
            message.textContent = text;
            message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 24px;
                border-radius: 4px;
                color: white;
                font-weight: bold;
                z-index: 10001;
                ${type === 'success' ? 'background-color: #4CAF50;' : 'background-color: #f44336;'}
            `;
            
            document.body.appendChild(message);
            
            setTimeout(() => {
                document.body.removeChild(message);
            }, 3000);
        }
        
        // Wait for tiles to load before enabling screenshot
        function waitForTilesToLoad() {
            const printButtons = document.querySelectorAll('.print-btn');
            
            // Disable buttons initially
            printButtons.forEach(btn => {
                btn.disabled = true;
                btn.textContent = btn.textContent.replace('ðŸ“‹', 'â³');
            });
            
            // Re-enable after a short delay to allow tiles to load
            setTimeout(() => {
                printButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.textContent = btn.textContent.replace('â³', 'ðŸ“‹');
                });
            }, 2000);
        }
        
        // Initialize everything when page loads
        window.onload = function() {
            initMap();
            waitForTilesToLoad();
        };
        
        // Handle window resize
        window.addEventListener('resize', function() {
            if (map) {
                setTimeout(() => map.invalidateSize(), 100);
            }
            if (printMapInstance) {
                setTimeout(() => printMapInstance.invalidateSize(), 100);
            }
        });
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('printModal');
            if (event.target === modal) {
                closePrintPreview();
            }
        };
    </script>
</body>
</html>